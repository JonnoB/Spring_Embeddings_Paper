---
title: "Untitled"
author: "Jonathan Bourne"
date: "13/09/2019"
output: html_document
---
This code needs to be run after the SytemDynamics set up chunk

```{r}
IEEE_data_folder <- file.path(basewd, "IEEE power flow data")
Project_folder <- "/media/jonno/Seagate Expansion Drive/IEEE_Networks"
IEEE_networks <- file.path(Project_folder, "IEEE_network_files")

```


#Create the network
```{r}
test <- read_delim(file = file.path(IEEE_data_folder, "ieee118cdf.txt"),
                       delim = " ",
                       #skip = 2,
                       col_names = FALSE)

#each file is broken up into cards which represent different parts of the network
#The first two cards are nodes and edges respectively. At the end of each of the main cards the number -999 is shown.
#The final -999 is the end of the file followby by a single text line.

card_end <- read_delim(file = file.path(IEEE_data_folder, "ieee118cdf.txt"),
                       delim = " ",
                       col_names = FALSE) %>% 
  pull(1) %>% 
  {. =="-999"} %>% 
  which

skip <- 2
nodes <- read_delim(file = file.path(IEEE_data_folder, "ieee118cdf.txt"),
                       delim = " ",
                       skip = skip,
                       col_names = FALSE,
                                       trim_ws = TRUE,
                   n_max = card_end[1]-1-skip) %>%
  set_names(c("Bus_Number", "Name", "Area_Number", "drop", "Loss_zone", "Type" , "final_voltage_pu", "final_angle_degs", "Load_MW", "LOAD_MVAR", "Generation_MW", "Generation_MVAR", "Base_KV", "Desired_volts_pu", "Max_MVAR", "Min_MVAR", "Conductance", "Susceptance", "Remote_controlled_Bus_number" )) 

#A couple of node names appear twice, so I use the Bus number as the official name of the node
#This causes issues to do with the edge name
test <- nodes %>%
  group_by(Bus_Number, Name) %>%
  summarise(counts = n()) %>%
  group_by(Name) %>%
  summarise(counts = n()) %>%
  filter(counts>1)

skip <- card_end[1]+1
edges <- read_delim(file = file.path(IEEE_data_folder, "ieee118cdf.txt"),
                   delim = " ",
                   skip = skip,
                   col_names = FALSE,
                   trim_ws = TRUE,
                   n_max = card_end[2]-1-skip) %>%
  set_names(c("Tap_bus_number", "Z_bus_number", "Load_flow_area", "Loss_zone", "Circuit", "Type", "Branch_resistance_R_pr_unit", "Branch_resistance_X_pr_unit", "Line_charging_B_pr_unit", "Line_MVA rating_No_1", "Line_MVA_rating_No_2", "Line_MVA_rating_No_3", "Control_bus_number", "Side", "Transformer_final_turns_ratio", "Transformer_final_angle", "Minimum_tap_phase_shift", "Maximum_tap_phase_shift", "Step_size", "Minimum_voltage", "Maximum_voltage"))


#The edges with near zero variance are unused anyway so I can drop them without issues
edges2 <- edges %>%
  mutate(Y = 1/Branch_resistance_X_pr_unit) %>%#We are using the DC assumuptions and the value of R is small compared to X thus we can say susceptance B = 1/X
  rename(from = Tap_bus_number, to = Z_bus_number) %>%
  select(-nearZeroVar(.),-Branch_resistance_R_pr_unit,-Branch_resistance_X_pr_unit) %>%
  left_join(select(nodes, from = Bus_Number, Name), by = "from")%>%
  left_join(select(nodes, to = Bus_Number, Name), by = "to") %>%
  mutate(Link = paste(Name.x, Name.y, sep = "-")) %>%
  select(-Name.x,-Name.y) %>%
  group_by(from, to) %>%
  #Remove parallel lines summing the susceptances
  summarise(Y = sum(Y),
            Link = first(Link)) 
  

  nodes2 <-nodes %>% select(-nearZeroVar(.)) %>%
      #A substantial amount of the generation is negative aka load, I move it into the load column
    mutate(
      Load_MW = if_else( Generation_MW<0,Load_MW-Generation_MW, Load_MW),
      Generation_MW = if_else(Generation_MW<0, 0, Generation_MW),
      Net_Generation = Generation_MW - Load_MW)


IEEE_118 <- graph_from_data_frame(edges2, vertices = nodes2, directed = FALSE)

#The forces need balancing
IEEE_118 <-  BalencedGenDem(IEEE_118, 
                   Demand = "Load_MW",
                   Generation = "Generation_MW",
                   OutputVar = "Net_Generation")

SlackRef <- SlackRefFunc(IEEE_118, name = "name", Generation = "Generation_MW")

IEEE_118 <- PowerFlow(IEEE_118, SlackRef$name, EdgeName ="Link", VertexName = "name", Net_generation = "Net_Generation")

saveRDS(IEEE_118, file = file.path(IEEE_networks, "IEEE_118_igraph.rds"))
    
```


#Plot 118

```{r}
test2 <- as_data_frame(IEEE_118) %>%
  mutate(absPF = abs(PowerFlow),
         rank = rank(absPF))


NodePosition <- test2 %>%
  select(from, to, Link, PowerFlow) %>%
  gather(key = type, value = Node, -Link, -PowerFlow)

 set.seed(158)
  BaseCoords <- layout_with_fr(IEEE_118) %>% 
    as_tibble %>% 
    mutate(Node = names(V(IEEE_118))) %>%
    rename(Longitude = V1,
           Latitude = V2) %>%
    left_join(NodePosition, .) %>%
    left_join(nodes2 %>% 
                select(Node = Bus_Number, Name, Net_Generation) %>% 
                mutate(Node = as.character(Node),
                       Node_type = case_when(Net_Generation ==0 ~"Transmission",
                                        Net_Generation > 0 ~"Generation",
                                        TRUE ~"Demand")), .)

  BaseCoords %>%
  ggplot(aes(x = Longitude, y = Latitude, group = Link)) + geom_line() +  
    geom_point(aes(shape = Node_type, colour = Node_type))
  
    BaseCoords %>%
  ggplot(aes(x = Longitude, y = Latitude, group = Link, colour = abs(PowerFlow))) + geom_line() +  
    geom_point(aes(shape = Node_type), size = 2) +
    scale_color_viridis_c()

```
