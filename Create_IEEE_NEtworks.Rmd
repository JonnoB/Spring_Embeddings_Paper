---
title: "Untitled"
author: "Jonathan Bourne"
date: "13/09/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
This code needs to be run after the SytemDynamics set up chunk

```{r}
IEEE_data_folder <- file.path(basewd, "IEEE power flow data")
Project_folder <- "/home/jonno/Dropbox/IEEE_Networks" #"/media/jonno/Seagate Expansion Drive/IEEE_Networks"
IEEE_networks <- file.path(Project_folder, "IEEE_network_files")

```


Data in common format from
http://labs.ece.uw.edu/pstca/
https://egriddata.org/dataset/ieee-30-bus-power-flow-test-case


A useful paper for cyber physical references and stufff to do with power grids. Electrical Engineer friendly
-Cyber-Physical Models for Power Grid Security Analysis: 8-Substation Case 

This paper says that the IEEE CDF is no longer in common use. Lends support to changing the format to one that is easier to understand.
-Integration and Adoption of Open Data Standards for Online and Offline Power System Analysis

Points of interest in The IEEE power flow test cases.

Columns  7-17   Name (A) (left justify) * . This column should start at 4 not 7

IEEE300 is different and for some reason has no real node names. the node names appear to be at the right of the data and not in the common format. either that or they are just the index of nodes to make it clear that there are indeed 300 nodes.

#Create the network

I need to also save the CSV files for the nodes and the edges and export them to the package. This allows non R users to be able to use the files and also it includes data lost in my igraph version

```{r}

c(14, 30, 57, 118, 300) %>% walk (~{
  print(paste0("Generating IEEE Power Flow Test Case ", .x))
  IEEE_number <- .x
  
  #make file name
  IEEE_version_name <- paste0("ieee", IEEE_number, "cdf.txt")
  
  raw_card <- read_delim(file = file.path(IEEE_data_folder, IEEE_version_name),
                         delim = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx1983xx",
                         col_names = FALSE)
  
  skip <- grep("^BUS", raw_card$X1)[1] #find the number of rows to skip by finding the first row that begins with BUS
  card_end <- grep("^-999", raw_card$X1) #Cards are separated by a line beginning -999
  
  
  {  #runa the nodes calc and re-name for IEEE300 together
    nodes <- read_fwf(
      file=file.path(IEEE_data_folder,  IEEE_version_name ),
      col_positions = 
        fwf_positions(start= c(1, 5,19,21,25,28,34,41,50,60,68,77,85,91,99, 107,115,124), 
                      end =  c(4,17,20,23,26,33,40,49,59,67,75,83,90,98,106,114,122,127), 
                      col_names = c("Tap_bus_number", "Name", "Load_flow area_number", "Loss_zone number", "Type", "Final_voltage", "Final angle", "Load_MW", "Load_MVAR", "Generation_MW", "Generation_MVAR", "Base_KV", "Desired_Volts", "Maximum_VAR", "Minimum_VAR", "Shunt_conductance", "Shunt_susceptance", "Remote_controlled_bus_number")),
      skip=skip,
      n_max = card_end[1]-1-skip
    ) 
    
    if(IEEE_number==300){
      nodes <- nodes %>%
        mutate(
          Name = 1:n())
    }
  }
  
  #Loading the edges shows warnings. These warnings are becuase the last column is too few columns. However, this doesn't matter as the column is empty for all the networks anyway
  edges <- read_fwf(
    file=file.path(IEEE_data_folder,  IEEE_version_name ),
    col_positions = 
      fwf_positions(start= c(1,6,11,13,17,19,20,30,41,51,57,63,69,74,77,84,91,98, 106,113,120), 
                    end =  c(4,9,12,14,17,19,29,40,50,55,61,67,72,74,82,90,97,104,111,119,126), 
                    col_names =   c("Tap_bus_number", "Z_bus", "Load_flow_area", "Loss_zone", "Circuit", "Type", "resistance_R", "reactance_X", "Line_charging_B", "Line_MVA_rating_No_1", "Line_MVA_rating_No_2", "Line_MVA_rating_No_3", "Control_bus_number", "Side", "Transformer_final turns_ratio", "Transformer_(phase shifter)_final angle", "Minimum_tap", "Maximum_tap", "Step_size", "Minimum_voltage", "Maximum_voltage")),
    skip=(card_end[1]+1),
    n_max = card_end[2]-1-(card_end[1]+1)
  )
  
  
  #The edges with near zero variance are unused anyway so I can drop them without issues
  edges2 <- edges %>%
    mutate(Y = 1/reactance_X) %>%#We are using the DC assumuptions and the value of R is small compared to X thus we can say susceptance B = 1/X
    select(-nearZeroVar(.)) %>%
    left_join(select(nodes, Tap_bus_number, Name), by = "Tap_bus_number") %>%
    left_join(select(nodes, Z_bus = Tap_bus_number, Name), by = "Z_bus") %>%
    mutate(Link = paste(Name.x, Name.y, sep = "-")) %>%
    select(-Name.x,-Name.y) %>%
    group_by(Tap_bus_number, Z_bus) %>%
    #Remove parallel lines summing the susceptances
    summarise(Y = sum(Y),
              Link = first(Link)) 
  
  
  nodes2 <-nodes %>%
    #A substantial amount of the generation is negative aka load, I move it into the load column
    mutate(
      Load_MW = if_else( Generation_MW < 0,Load_MW-Generation_MW, Load_MW),
      Generation_MW = if_else(Generation_MW < 0, 0, Generation_MW),
      Net_Generation = Generation_MW - Load_MW)
  
  
  IEEE_netowork <- graph_from_data_frame(edges2, vertices = nodes2, directed = FALSE)
  
  #The forces need balancing
  IEEE_netowork <-  BalencedGenDem(IEEE_netowork, 
                                   Demand = "Load_MW",
                                   Generation = "Generation_MW",
                                   OutputVar = "Net_Generation")
  
  SlackRef <- SlackRefFunc(IEEE_netowork, name = "name", Generation = "Generation_MW")
  
  IEEE_netowork <- PowerFlow(IEEE_netowork, SlackRef$name, EdgeName ="Link", VertexName = "name", Net_generation = "Net_Generation")
  
  saveRDS(IEEE_netowork, file = file.path(IEEE_networks, paste0("IEEE_", IEEE_number, "_igraph.rds")))
  
  write_csv(nodes, file.path(IEEE_networks, paste0("IEEE_", IEEE_number, "_nodes.csv")))
  write_csv(edges, file.path(IEEE_networks, paste0("IEEE_", IEEE_number, "_edges.csv")))
  
})


```


#Plot 118

```{r}

 {IEEE_number <- 14

g <- read_rds(file.path(IEEE_networks, paste0("IEEE_", IEEE_number, "_igraph.rds")))

test2 <- as_data_frame(g) %>%
  mutate(absPF = abs(PowerFlow),
         rank = rank(absPF))


NodePosition <- test2 %>%
  select(from, to, Link, PowerFlow) %>%
  gather(key = type, value = Node, -Link, -PowerFlow)

 set.seed(158)
  BaseCoords <- layout_with_fr(g) %>% 
    as_tibble %>% 
    mutate(Node = names(V(g))) %>%
    rename(Longitude = V1,
           Latitude = V2) %>%
    left_join(NodePosition, .) %>%
    left_join(as_data_frame(g, what = "vertices") %>% 
                select(Node = name, Name, Net_Generation) %>% 
                mutate(Node = as.character(Node),
                       Node_type = case_when(Net_Generation ==0 ~"Transmission",
                                        Net_Generation > 0 ~"Generation",
                                        TRUE ~"Demand")), .)

  BaseCoords %>%
  ggplot(aes(x = Longitude, y = Latitude, group = Link)) + geom_line() +  
    geom_point(aes(shape = Node_type, colour = Node_type))
  
    BaseCoords %>%
  ggplot(aes(x = Longitude, y = Latitude, group = Link, colour = abs(PowerFlow))) + geom_line() +  
    geom_point(aes(shape = Node_type), size = 2) +
    scale_color_viridis_c()}

```



#Matpower version

explanation of the matpower case format can be found here
https://matpower.org/docs/ref/matpower5.0/caseformat.html

```{r}

the_ieee_test_cases<- list.files("/home/jonno/pglib-opf-master", pattern = "ieee.m", full.names = TRUE)

the_ieee_test_cases

matpower_loader(the_ieee_test_cases[1], output_graph = F)

```

